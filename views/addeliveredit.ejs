<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h3 class="page-header">Ad投放策略Edit</h3>
    <div id="table-responsive-upload">
        <form enctype="multipart/form-data" method="POST" action="/data/updateAddeliverData" role="form" class="form-horizontal" id="J_addeliverForm">
            <input type="hidden" name="id">
            <input type="hidden" name="adx_name" value="<%if(locals.adx_name){%><%=locals.adx_name%><%}%>">
            <input type="hidden" name="mgr_user_id" value="<%if(locals.userid){%><%=locals.userid%><%}%>">
            <div class="form-group">
                <label class="col-sm-2 control-label" for="adid">ad_id</label>
                <div class="col-sm-3">
                    <select class="form-control" id="adid" name="ad_id">
                        <% for(var i= 0,len=adData.length; i<len; i++){%>
                        <option value="<%=adData[i]['id']%>"><%=adData[i]['ad_name']%></option>
                        <%}%>
                    </select>
                    <div class="form-control-required text-danger">*</div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="J_selectapp">app_list</label>
                <div class="col-sm-3">
                    <input id="J_selectapp" data-toggle="modal" data-target="#J_selectappmodaldialog" class="validate[required] country-btn btn btn-default" type="text" readonly="readonly" placeholder="select app / app group ..." value="" style="width:100%;">
                    <input id="J_selectappvalue" name="app_list" type="hidden" class="form-control" value="">
                    <div class="form-control-required text-danger">*</div>
                </div>
            </div>
            <!--
            <div class="form-group">
                <label class="col-sm-2 control-label" for="adx_name">adx_name</label>
                <div class="col-sm-3">
                    <input type="text" placeholder="adx_name" name="adx_name" class="validate[required] form-control" id="adx_name">
                    <div class="form-control-required text-danger">*</div>
                </div>
            </div>
            -->
            <!--
            <div class="form-group">
                <label class="col-sm-2 control-label" for="filter_list">filter_list</label>
                <div class="col-sm-3">
                    <input type="text" placeholder="filter_list" name="filter_list" class="validate[required] form-control" id="filter_list">
                    <div class="form-control-required text-danger">*</div>
                </div>
            </div>
            -->
            <div class="form-group">
                <label class="col-sm-2 control-label" for="osv_s">version</label>
                <div class="col-sm-1" style="width: 135px;">
                    <input type="text" placeholder="start version" name="osv_s" class="validate[required] form-control" id="osv_s" value="">
                    <div class="form-control-required text-danger">*</div>
                </div>
                <div class="col-sm-1" style="width: 135px;">
                    <input type="text" placeholder="end version" name="osv_e" class="form-control" id="osv_e" value="">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="age_s">age</label>
                <div class="col-sm-1" style="width: 135px;">
                    <input type="text" placeholder="start age" name="age_s" class="form-control" id="age_s" value="">
                </div>
                <div class="col-sm-1" style="width: 135px;">
                    <input type="text" placeholder="end age" name="age_e" class="form-control" id="age_e" value="">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="gender">gender</label>
                <div class="col-sm-3">
                    <select class="form-control" id="gender" name="gender">
                        <option value="M">Man</option>
                        <option value="W">Female</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="">connectiontype</label>
                <div class="col-sm-5" style="width: 450px;">
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="4g">
                            <input type="checkbox" id="4g" name="connectiontype" value="6">
                            4G
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="3g">
                            <input type="checkbox" id="3g" name="connectiontype" value="5">
                            3G
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="2g">
                            <input type="checkbox" id="2g" name="connectiontype" value="4">
                            2G
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="wifi">
                            <input type="checkbox" id="wifi" data-name="wifi"name="connectiontype" value="2">
                            Wifi
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="ethernet">
                            <input type="checkbox" id="ethernet" name="connectiontype" value="1">
                            Ethernet
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 120px; padding-left:0px;">
                        <label for="unknown">
                            <input type="checkbox" id="unknown" name="connectiontype" value="0">
                            Unknown
                        </label>
                    </div>
                    <div class="checkbox col-sm-2" style="width: 240px; padding-left:0px;">
                        <label for="unknowngeneration">
                            <input type="checkbox" id="unknowngeneration" name="connectiontype" value="3">
                            Unknown Generation
                        </label>
                    </div>
                </div>
            </div>
            <!--
            <div class="form-group">
                <label class="col-sm-2 control-label" for="mgr_user_id">mgr_user_id</label>
                <div class="col-sm-3">
                    <input type="text" placeholder="mgr_user_id" name="mgr_user_id" class="validate[required, min[1], custom[number]] form-control" id="mgr_user_id">
                    <div class="form-control-required text-danger">*</div>
                </div>
            </div>
            -->
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button id="J_submitBtn" class="btn btn-default btn-primary" type="submit" data-submit-target-url="" data-submit-redirect="/addeliver">Submit</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div id="J_selectappmodaldialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog" style="width: 1000px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">Select App / AppGroup</h4>
            </div>
            <div class="modal-body" style="overflow-y: auto; padding:5px;">
                <table class="table table-striped" id="J_tableAppList" style="width:100%;">
                    <tr style=" background-color: #FFF;"><td style="text-align: center; border: 0px;">loading ...</td></tr>
                </table>
                <br />
                <table class="table table-striped" id="J_tableAppGroupList" style="width:100%;">
                    <tr style=" background-color: #FFF;"><td style="text-align: center; border: 0px;">loading ...</td></tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" id="J_confirmbtn" class="btn btn-default" data-initialize="F">Confirm</button>
                <button type="button" id="J_cancelbtn" class="btn btn-default">Cancel</button>
            </div>
        </div>
    </div>
</div>
<link type="text/css" rel="stylesheet" href="/stylesheets/validationEngine.jquery.css" />
<style type="text/css">
#J_selectappmodaldialog table#J_tableAppList tbody tr td:last-child{ padding-top:4px; padding-bottom: 0px;}
#J_selectappmodaldialog table.dataTable tfoot th{ padding-left: 2px;}
</style>
<script type="text/javascript" src="/javascripts/jquery.validationEngine.js"></script>
<script type="text/javascript" src="/javascripts/jquery.validationEngine-en.js"></script>
<script type="text/javascript" src="/javascripts/plugin.js"></script>
<script type="text/javascript">
;(function($, window) {
    //addeliveredit page
    window.addeliveredit = {
        initData: {
            "app": {},
            "appGroup": {}
        },
        init: function () {
            //validator form
            $("#J_addeliverForm").validationEngine();
            //submit form and init form
            this.initPage();
            //
            this.selectApp();
        },
        initPage:function(){
            window.MyObj.FormPage.init({
                "submitBtnId": "#J_submitBtn" || null,
                "uuid": "id",
                "getCurDataUrl": "/data/getAddliverData"
            });
        },
        selectApp:function(){
            new SelectMulOptForMulTab({
                "selectItem": $("#J_selectapp"),                       //选择按钮
                "saveAppValIpt": $("#J_selectappvalue"),               //存值隐藏域
                "confirmBtn": $('#J_confirmbtn'),                      //确认
                "cancelBtn": $('#J_cancelbtn'),                        //取消
                "modaldialog": $("#J_selectappmodaldialog"),           //浮层
                "tableOps": {
                    "app": {
                        "sessionDataKey": "appListDatas",
                        "renderElement": $("#J_tableAppList"),
                        "getDataUrl": "/data/getAppDataListDetail",
                        "table": null,
                        "getDataRequest": null,
                        "dataList": {"data": []},
                        "tableOption": {
                            "paging": true, //分页
                            "ordering": true, //排序
                            "info": false, //信息（左下）
                            "lengthChange": false, //每页条数
                            "searching": true, //搜索
                            "pageLength": 5,
                            "scrollX": true,
                            "columns": [
                                { "data": "id" },
                                { "data": "adx_name" },
                                { "data": "appid" },
                                { "data": "appname" },
                                { "data": "country" },
                                { "data": "size" },
                                { "data": "os" },
                                { "data": "category" },
                                {
                                    "data": "id",
                                    "orderable": false,
                                    "render": function (data, type, full, meta) {
                                        return '<input type="text" data-name="price" onclick="(function(event){ e = event || window.event; if(e.stopPropagation){ e.stopPropagation(); }else { e.cancelBubble = true; }})(event);" name="price-' + data + '" style="width: 50px;">';
                                    }
                                }
                            ],
                            "order": [
                                [0, 'asc']
                            ],
                            "drawCallback": function (settings) {
                                var ids = window.addeliveredit.initData.app,
                                        tbody = $("#J_tableAppList").find("tbody"),
                                        confirmBtn = $("#J_confirmbtn"),
                                        prIpt = null;
                                setTimeout(function () {
                                    tbody.find("tr").removeClass("selected");
                                    tbody.find("tr input[data-name=price]").val('');
                                    for (var id in ids) {
                                        prIpt = $("input[name='price-" + id + "']");
                                        prIpt && prIpt.val(ids[id]);
                                        prIpt && prIpt.parents("tr").addClass("selected");
                                    }
                                    confirmBtn.attr("data-initialize", "T").removeClass("btn-default").addClass("btn-primary");
                                }, 0);

                            },
                            "rowCallback": function (row, data) {
                                //console.log(data);
                            }
                        },
                        "tableTpml": '<thead><tr>' +
                                '<th>id</th>' +
                                '<th>adx_name</th>' +
                                '<th>appid</th>' +
                                '<th>appname</th>' +
                                '<th>country</th>' +
                                '<th>size</th>' +
                                '<th>os</th>' +
                                '<th>category</th>' +
                                '<th>price</th>' +
                                '</tr></thead>' +
                                '<tfoot><tr>' +
                                '<th></th>' +
                                '<th></th>' +
                                '<th><input type="text" placeholder="Appid" style="width: 60px;" /></th>' +
                                '<th><input type="text" placeholder="Appname" style="width: 100px;" /></th>' +
                                '<th><input type="text" placeholder="Country" style="width: 65px;" /></th>' +
                                '<th><input type="text" placeholder="Size" style="width: 60px;" /></th>' +
                                '<th><input type="text" placeholder="Os" style="width: 70px;" /></th>' +
                                '<th><input type="text" placeholder="Category" style="width: 70px;" /></th>' +
                                '<th></th>' +
                                '</tr></tfoot>'
                    },
                    "appGroup": {
                        "sessionDataKey": "appGroupListDatas",
                        "renderElement": $("#J_tableAppGroupList"),
                        "getDataUrl": "/data/getAppgroupDataList",
                        "table": null,
                        "getDataRequest": null,
                        "dataList": {"data": []},
                        "tableOption": {
                            "paging": true, //分页
                            "ordering": true, //排序
                            "info": false, //信息（左下）
                            "lengthChange": false, //每页条数
                            "searching": true, //搜索
                            "pageLength": 5,
                            //"serverSide": false,
                            //"ajax": "/data/getAppDataList",
                            //"data": gdata,
                            "scrollX": true,
                            "columns": [
                                { "data": "id" },
                                { "data": "app_group_name" },
                                { "data": "description" },
                                { "data": "app_list" },
                                {
                                    "data": "id",
                                    "orderable": false,
                                    "render": function (data, type, full, meta) {
                                        return '<input type="text" data-name="price" onclick="(function(event){ e = event || window.event; if(e.stopPropagation){ e.stopPropagation(); }else { e.cancelBubble = true; }})(event);" name="price-' + data + '" style="width: 50px;">';
                                    }
                                }
                            ],
                            "order": [
                                [0, 'asc']
                            ],
                            "drawCallback": function (settings) {
                                var ids = window.addeliveredit.initData.appGroup,
                                        tbody = $("#J_tableAppList").find("tbody"),
                                        confirmBtn = $("#J_confirmbtn"),
                                        prIpt = null;
                                setTimeout(function () {
                                    tbody.find("tr").removeClass("selected");
                                    tbody.find("tr input[data-name=price]").val('');
                                    for (var id in ids) {
                                        prIpt = $("input[name='price-" + id + "']");
                                        prIpt && prIpt.val(ids[id]);
                                        prIpt && prIpt.parents("tr").addClass("selected");
                                    }
                                    confirmBtn.attr("data-initialize", "T").removeClass("btn-default").addClass("btn-primary");
                                }, 0);

                            },
                            "rowCallback": function (row, data) {
                                //console.log(data);
                            }
                        },
                        "tableTpml": '<thead><tr>' +
                                '<th>id</th>' +
                                '<th>app_group_name</th>' +
                                '<th>description</th>' +
                                '<th>app_list</th>' +
                                '<th>price</th>' +
                                '</tr></thead>' +
                                '<tfoot><tr>' +
                                '<th></th>' +
                                '<th><input type="text" placeholder="App Group Name" style="width: 100px;" /></th>' +
                                '<th><input type="text" placeholder="Description" style="width: 65px;" /></th>' +
                                '<th><input type="text" placeholder="App List" style="width: 60px;" /></th>' +
                                '<th></th>' +
                                '</tr></tfoot>'
                    }
                },
                "bindEvent":function(){
                    var _this = this;
                    this.selectItem.on("click", function (event) {
                        var vals = $("#J_selectappvalue").val() || '', tableOps = _this.tableOps;
                        vals && (window.addeliveredit.initData = $.parseJSON(vals.replace(/'/g, '"')));
                        for(var key in tableOps){
                            if(!tableOps[key]['table']){
                                //渲染表格
                                _this.renderTable.apply(_this, [ event, tableOps[key]]);
                            }
                        }
                    });
                },
                "confirmCallback": function (event) {
                    var _this = this, elem = $(event.target), datas = null, keys = [], values = {"app":[],"appGroup":[]}, obj = {};
                    var tableOps = _this.tableOps, i, len;
                    if (elem.attr("data-initialize") === "F") {
                        return;
                    }
                    for(var key in tableOps){
                        if(key === "app" && tableOps[key]['table']){
                            datas = tableOps[key]['table'].rows('.selected').data();
                            for (i = 0,len = datas.length; i < len; i++) {
                                obj = {};
                                obj['id'] = datas[i]['id'];
                                obj['appid'] = datas[i]['appid'];
                                obj['appname'] = datas[i]['appname'];
                                obj['price'] = $("input[name=price-"+datas[i]['id']+"]").val();
                                keys.push(datas[i]['appname'])
                                obj && values.app.push(obj);
                            }
                        }
                        if(key === "appGroup" && tableOps[key]['table']){
                            datas = tableOps[key]['table'].rows('.selected').data();
                            for (i = 0,len = datas.length; i < len; i++) {
                                obj = {};
                                obj['id'] = datas[i]['id'];
                                obj['app_list'] = datas[i]['app_list'] ? $.parseJSON(datas[i]['app_list'].replace(/'/g, '"')) : {};
                                obj['app_group_name'] = datas[i]['app_group_name'];
                                obj['price'] = $("input[name=price-"+datas[i]['id']+"]").val();
                                keys.push(datas[i]['app_group_name'])
                                obj && values.appGroup.push(obj);
                            }
                        }
                    }
                    this.selectItem.val(keys.join(","));
                    this.saveAppValIpt.val(JSON.stringify(values).replace(/"/g, "'"));
                    //
                    this.hideModaldialog();
                }
            });
        }
    };
    //
    $(function () {
        //initialize addeliveredit page
        window.addeliveredit.init();
    });
})(jQuery, window);
</script>